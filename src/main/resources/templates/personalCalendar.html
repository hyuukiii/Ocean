<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>개인 캘린더</title>
    <link th:href="@{/css/lnb.css}" rel='stylesheet' />
    <link th:href="@{/css/calendar.css}" rel='stylesheet' />
    <link rel="stylesheet" href="/static/css/calendar.css">

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
    </style>
</head>

<body>
    <div class="app-container">
            <nav>
                <div th:replace="~{fragments/lnb :: lnbFragment}"></div>
            </nav>

        <div class="main-content">
            <div class="calendar-header">
                <div class="nav-arrows">
                    <button id="prevMonthBtn" class="icon-arrow-left"></button>
                    <span id="currentMonthText" class="current-month">6 JUN 2025</span>
                    <button id="nextMonthBtn" class="icon-arrow-right"></button>
                </div>
            </div>
            <div id='calendar'></div>
        </div>

        <div class="sidebar-right"></div>
    </div>

    <div id="createEventModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>개인 일정 추가</h3>
                <button type="button" class="modal-close-button" onclick="closeCreateEventModal()">&times;</button>
            </div>
            <form id="eventForm" onsubmit="event.preventDefault(); saveEvent();">
                <div class="form-group flex-container">
                    <input type="text" id="title" name="title" placeholder="제목을 입력하세요" required
                           oninvalid="this.setCustomValidity('제목은 필수 입력 사항입니다.')"
                           oninput="this.setCustomValidity('')">
                    <input type="color" id="color" name="color" value="#0066CC">
                </div>

                <div class="form-group">
                    <label class="icon-clock">일시</label>
                    <div class="datetime-group">
                        <input type="datetime-local" id="startDatetime" name="startDatetime" required>
                        <span>&mdash;</span>
                        <input type="datetime-local" id="endDatetime" name="endDatetime" required>
                    </div>
                    <div class="checkbox-container">
                        <label for="allDay">종일</label>
                        <input type="checkbox" id="allDay" name="allDay">
                    </div>
                </div>

                <div class="form-group">
                    <label class="icon-user-detail">참가자 선택</label>
                    <div class="checkbox-container" id="workspaceMembers"></div>
                </div>

                <div class="form-group">
                    <label for="description" class="icon-description">설명 추가</label>
                    <textarea id="description" name="description"  placeholder="자세한 설명을 입력하세요."></textarea>
                </div>


                <div class="form-group">
                    <div class="file-input-container">
                        <span class="icon icon-attach"></span>
                        <span>첨부파일 추가</span>
                        <input type="file" id="fileUpload" name="files" multiple>
                    </div>
                    <ul id="insertedFiles" style="list-style: none; padding: 0; margin-top: 10px;"></ul>
                </div>

                <div class="form-group">
                    <label for="notification" class="icon-bell">알림 시간</label>
                    <select id="notification" name="notification" required>
                        <option value="0">알림 없음</option>
                        <option value="1440">전날 오전 9시</option>
                        <option value="540">당일 오전 9시</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="location" class="icon-location">위치 추가</label>
                    <input type="text" id="location" name="location" placeholder="위치를 입력하거나 지도에서 선택하세요.">
                    <div class="map-placeholder">
                        <p>지도 API가 표시될 공간</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="priority" class="icon-priority">중요도</label>
                    <select id="priority" name="priority" required>
                        <option value="LOW">낮음</option>
                        <option value="NORMAL" selected>보통</option>
                        <option value="HIGH">높음</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="isShared">공유 여부</label>
                    <select id="isShared" name="isShared">
                        <option value="0">비공유</option>
                        <option value="1">공유</option>
                    </select>
                </div>


                <div class="submit-button-wrapper">
                    <button type="submit">등록하기</button>
                </div>
            </form>
        </div>
    </div>

    <div id="eventDetailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="header-actions">
                <button type="button" class="edit-button" title="수정" style="display:none;" onclick="openUpdateModal()">
                    <span class="icon icon-edit"></span>
                </button>
                <button type="button" class="delete-button" title="삭제" style="display:none;" onclick="deleteEvent()">
                    <span class="icon icon-delete"></span>
                </button>
                <button type="button" class="modal-close-button" onclick="closeDetailModal()">
                    <span class="icon icon-close"></span>
                </button>
            </div>

            <div class="title-section">
                <div class="color-dot" th:style="'background-color:' + ${event?.color}"></div>
                <div class="text-content">
                    <div class="main-title" id="detailTitle" th:text="${event?.title}">제목 없음</div>
                    <div class="sub-text">
                        <span
                            th:if="${event?.startDatetime != null and event?.endDatetime != null and #temporals.format(event.startDatetime, 'yyyyMMdd') == #temporals.format(event.endDatetime, 'yyyyMMdd') and #temporals.format(event.startDatetime, 'HHmm') == '0000' and #temporals.format(event.endDatetime, 'HHmm') == '2359'}">
                            <span th:text="${#temporals.format(event.startDatetime, 'M월 d일 (E)')} + ' 종일'"></span>
                        </span>
                        <span
                            th:unless="${event?.startDatetime == null or event?.endDatetime == null or (#temporals.format(event.startDatetime, 'yyyyMMdd') == #temporals.format(event.endDatetime, 'yyyyMMdd') and #temporals.format(event.startDatetime, 'HHmm') == '0000' and #temporals.format(event.endDatetime, 'HHmm') == '2359')}">
                            <span
                                th:text="${event?.startDatetime != null ? #temporals.format(event.startDatetime, 'M월 d일 (E) a h:mm') : '시작일 없음'}"></span>
                            <span> - </span>
                            <span
                                th:text="${event?.endDatetime != null ? #temporals.format(event.endDatetime, 'M월 d일 (E) a h:mm') : '종료일 없음'}"></span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="info-item">
                <span class="icon icon-user-detail"></span>
                <div class="value" id="detailAuthor"></div>
            </div>

            <div class="info-item">
                <span class="icon icon-user-detail"></span>
                <div class="value" id="detailWorkspaceMembers">참가자</div>
            </div>

            <div class="info-item">
                <span class="icon icon-location-detail"></span>
                <div class="value" id="detailLocation"></div>
            </div>

            <div class="info-item description">
                <span class="icon icon-description-detail"></span>
                <div class="value" id="detailDescriptionDisplay"></div>
            </div>

            <div class="info-item">
                <span class="icon icon-bell-detail"></span>
                <div class="value" id="detailNotification"></div>
            </div>

            <div class="info-item">
                <span class="icon icon-attachment-detail"></span>
                <div class="value">
                    <ul id="detailFiles" class="attachments-list"></ul>
                </div>
            </div>

            <div class="info-item">
                <span class="icon icon-priority"></span>
                <div class="value" id="detailPriority"></div>
            </div>

            <div class="info-item">
                <span class="icon icon-user-detail"></span>
                <div class="value" id="detailShared"></div>
            </div>


            <div class="modal-footer">
                <button type="button" onclick="closeDetailModal()">닫기</button>
            </div>
        </div>
    </div>

    <div id="updateEventModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>일정 수정</h3>
                <button type="button" class="modal-close-button" onclick="closeUpdateModal()">&times;</button>
            </div>
            <form id="updateEventForm">
                <input type="hidden" id="update-eventCd" name="eventCd" />

                <div class="form-group flex-container">
                    <input type="text" id="update-title" name="title" placeholder="제목" required
                           oninvalid="this.setCustomValidity('제목은 필수 입력 사항입니다.')"
                           oninput="this.setCustomValidity('')">
                    <input type="color" id="update-color" name="color" value="#0066CC">
                </div>

                <div class="form-group">
                    <label class="icon-clock">시작 일시</label>
                    <input type="datetime-local" id="update-startDatetime" name="startDatetime" required>
                </div>

                <div class="form-group">
                    <label class="icon-clock">종료 일시</label>
                    <input type="datetime-local" id="update-endDatetime" name="endDatetime" required>
                </div>

                <div class="form-group">
                    <label class="icon-user-detail">참가자 선택</label>
                    <div class="checkbox-container" id="update-workspaceMembers"></div>
                </div>

                <div class="form-group">
                    <label for="update-description" class="icon-description">설명</label>
                    <textarea id="update-description" name="description" rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label class="icon-attach">기존 파일</label>
                    <ul id="updateFiles" class="current-files-list"></ul>
                    <label class="icon-attach" style="margin-top: 15px;">새 파일 첨부:</label>
                    <input type="file" id="update-fileUpload" name="files" multiple>
                </div>

                <div class="form-group">
                    <label for="update-notification" class="icon-bell">알림</label>
                    <select id="update-notification" name="notification">
                        <option value="1440">전날 오전 9시</option>
                        <option value="540">당일 오전 9시</option>
                        <option value="0">알림 없음</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="update-location" class="icon-location">위치</label>
                    <input type="text" id="update-location" name="location" placeholder="위치">
                </div>

                <div class="form-group">
                    <label for="update-priority" class="icon-priority">우선순위</label>
                    <select id="update-priority" name="priority">
                        <option value="LOW">낮음</option>
                        <option value="NORMAL">보통</option>
                        <option value="HIGH">높음</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="update-progressStatus">진행 상태</label>
                    <select id="update-progressStatus" name="progressStatus">
                        <option value="TODO">예정</option>
                        <option value="IN_PROGRESS">진행중</option>
                        <option value="DONE">완료</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="update-isShared">공유 여부</label>
                    <select id="update-isShared" name="isShared">
                        <option value="0">비공유</option>
                        <option value="1">공유</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="submitUpdateEvent()">수정하기</button>
                    <button type="button" class="cancel-button" onclick="closeUpdateModal()">취소</button>
                </div>
            </form>
        </div>
    </div>


    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentUser = /*[[${currentUser}]]*/ '';
        const workspaceCd = /*[[${workspaceCd}]]*/ '';

        console.log("currentUser: " + currentUser.userId);
        console.log("workspaceCd: " + workspaceCd);
        // 현재 로그인 사용자 ID는 백엔드에서 주입되어야 합니다. (더미값)
        /*
        fetch(`/api/user/profile`)
            .then(res => {
                if (!res.ok) throw new Error("유저 정보 조회 실패");
                return res.json();
            })
            .then((data)=>{
                //
                const currentUserId = data.userId;
            })
            .catch(err => {
                console.error(err);
            });*/


        const currentUserId = currentUser.userId;
        const currentUserName = currentUser.userName;
        console.log("currentUserName: " + currentUserName);

        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                height: 'auto', // 캘린더 높이 자동 조절
                initialDate: new Date(),
                // 날짜 클릭시 : 일정 추가하는 함수 (createEventModal 띄움)
                dateClick: async function (info) {
                    closeDetailModal(); // 혹시 열려있는 상세 모달 닫기
                    closeUpdateModal(); // 혹시 열려있는 수정 모달 닫기

                    document.getElementById('eventForm').reset(); // 폼 초기화
                    // 클릭된 날짜로 시작/종료 일시 기본값 설정
                    document.getElementById('startDatetime').value = info.dateStr + 'T09:00';
                    document.getElementById('endDatetime').value = info.dateStr + 'T18:00';
                    selectedFiles = [];
                    document.getElementById('insertedFiles').innerHTML = ''; // 파일 목록 초기화
                    document.getElementById('workspaceMembers').innerHTML = '';


                    fetch(`/api/getMembers?workspaceCd=${workspaceCd}`)
                        .then(res => {
                            if (!res.ok) throw new Error("멤버정보 조회 실패");
                            return res.json();
                        })
                        .then(data => {
                            const membersData = data;
                            const container = document.getElementById('workspaceMembers');

                            for (let i = 0; i < membersData.length; i++) {
                                const member = membersData[i];

                                const checkbox = document.createElement('input');
                                checkbox.type = 'checkbox';

                                checkbox.name = 'attendenceIds';

                                const uniqueId = 'userId' + member.userId;
                                checkbox.id = uniqueId;
                                checkbox.value = member.userId;

                                const label = document.createElement('label');
                                label.htmlFor = uniqueId; // id랑 연결
                                label.textContent = member.userNickname;

                                 // 현재 로그인한 사용자라면 체크 + 숨기기
                                if (member.userId === currentUserId) {
                                    checkbox.checked = true;
                                    checkbox.style.display = 'none';
                                    label.style.display = 'none';
                                }

                                container.appendChild(checkbox);
                                container.appendChild(label);
                                container.appendChild(document.createElement('br'));
                            }

                        });
                    document.getElementById('createEventModal').style.display = 'flex'; // 모달 표시
                },
                // 개인일정 리스트 풀캘린더에 뿌려주는 부분
                events: function (fetchInfo, successCallback, failureCallback) {
                    // userId는 currentUserId를 사용하거나, 백엔드에서 인증 정보로 자동 처리
                    fetch(`/api/calendar/personal?userId=${currentUserId}`)
                        .then(response => {
                            if (!response.ok) throw new Error("불러오기 실패!");
                            return response.json();
                        })
                        .then(data => {
                            const events = data.map(item => ({
                                id: item.eventCd,
                                title: item.title,
                                start: item.startDatetime,
                                end: item.endDatetime,
                                color: item.color
                            }));
                            successCallback(events);
                        })
                        .catch(err => {
                            console.error(err);
                            failureCallback(err);
                        });
                },
                // 일정 클릭 이벤트 : 일정 상세 모달창 띄움
                eventClick: function (info) {
                    closeCreateEventModal(); // 혹시 열려있는 생성 모달 닫기
                    closeUpdateModal(); // 혹시 열려있는 수정 모달 닫기

                    const eventCd = info.event.id;
                    fetch(`/api/calendar/personal/events/${eventCd}`)
                        .then(res => {
                            console.log("응답 상태코드:", res.status);
                            if (!res.ok) throw new Error("상세정보 조회 실패");
                            return res.json();
                        })
                        .then(data => {
                            const event = data.event;

                            console.log("event", event);
                            console.log("currentUserId", currentUserId);

                            document.getElementById('detailTitle').innerText = event.title || '제목 없음';
                            document.getElementById('detailAuthor').innerText = event.userName || event.userId || '알 수 없음';

                            document.getElementById('detailDescriptionDisplay').innerText = event.description || '설명 없음';
                            document.getElementById('detailPriority').innerText = event.priority;
                            document.getElementById('detailShared').innerText = event.isShared === '1' ? '예' : '아니오';
                            // 알림 시간 포맷팅
                            const notifyTimeMinutes = event.notifyTime; // 가정: notifyTime은 분 단위 숫자
                            let notificationText = '알림 없음';
                            if (notifyTimeMinutes > 0) {
                                if (notifyTimeMinutes === 1440) notificationText = '전날 9시';
                                else if (notifyTimeMinutes === 540) notificationText = '당일 9시';
                            }
                            document.getElementById('detailNotification').innerText = notificationText;

                            const membersContainer = document.getElementById('detailWorkspaceMembers');
                            if (data.attendences && data.attendences.length > 0) {
                                const names = data.attendences
                                    .map(m => m.userNickName || m.userId)
                                    .join(", ");
                                membersContainer.innerText = names;
                            } else {
                                membersContainer.innerText = '참가자 없음';
                            }

                            // 날짜 및 시간 포맷팅 (FullCalendar 날짜 형식에 따라 조정)
                            // ISO 문자열을 Date 객체로 변환하여 포맷팅
                            const startDateTime = event.startDatetime ? new Date(event.startDatetime) : null;
                            const endDateTime = event.endDatetime ? new Date(event.endDatetime) : null;

                            let dateTimeDisplay = '';
                            if (startDateTime && endDateTime) {
                                const startDateFormatted = formatDate(startDateTime, 'M월 d일 (E)');
                                const startTimeFormatted = formatDate(startDateTime, 'a h:mm');
                                const endDateFormatted = formatDate(endDateTime, 'M월 d일 (E)');
                                const endTimeFormatted = formatDate(endDateTime, 'a h:mm');

                                // 종일 이벤트 확인 (00:00 - 23:59:59)
                                const isAllDay = startDateTime.getHours() === 0 && startDateTime.getMinutes() === 0 &&
                                    endDateTime.getHours() === 23 && endDateTime.getMinutes() === 59; // 초, 밀리초는 무시

                                if (isAllDay && startDateFormatted === formatDate(endDateTime, 'M월 d일 (E)')) {
                                    dateTimeDisplay = `${startDateFormatted} 종일`;
                                } else {
                                    dateTimeDisplay = `${startDateFormatted} ${startTimeFormatted} - ${endDateFormatted} ${endTimeFormatted}`;
                                }
                            } else {
                                dateTimeDisplay = '일시 정보 없음';
                            }
                            document.querySelector('#eventDetailModal .sub-text').innerText = dateTimeDisplay;


                            // 이벤트 색상 표시 업데이트
                            document.querySelector('#eventDetailModal .color-dot').style.backgroundColor = event.color || '#007bff';

                            // 위치 연결 필요
                            document.getElementById('detailLocation').innerText = data.location || '위치 정보 없음';

                            // 첨부파일 목록
                            /*const detailFilesUl = document.getElementById('detailFiles');
                            detailFilesUl.innerHTML = ''; // 기존 목록 초기화
                            if (data.fileList && data.fileList.length > 0) {
                                data.fileList.forEach(file => {
                                    const li = document.createElement('li');
                                    li.innerHTML = `
                                  <a href="/api/calendar/personal/events/${eventCd}/files?fileId=${file.fileId}" target="_blank">
                                      <span class="file-icon icon-file-doc"></span>
                                      <span>${file.fileNm}</span>
                                  </a>
                                  <a href="/api/calendar/personal/events/${eventCd}/files?fileId=${file.fileId}" title="다운로드" class="download-icon">
                                      ⬇️
                                  </a>
                              `;
                                    detailFilesUl.appendChild(li);
                                });
                            } else {
                                const li = document.createElement('li');
                                li.innerText = '첨부파일 없음';
                                detailFilesUl.appendChild(li);
                            }*/

                            const detailFilesUl = document.getElementById('detailFiles');
                            detailFilesUl.innerHTML = '';
                            if (data.fileList && data.fileList.length > 0) {
                              data.fileList.forEach(file => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                  <a href="/api/calendar/personal/events/${event.eventCd}/files?fileId=${file.fileId}" target="_blank">
                                    <span class="file-icon icon-file-doc"></span>
                                    <span>${file.fileNm}</span>
                                  </a>
                                  <a href="/api/calendar/personal/events/${event.eventCd}/files?fileId=${file.fileId}" title="다운로드" class="download-icon">⬇️</a>
                                `;
                                detailFilesUl.appendChild(li);
                              });
                            } else {
                              const li = document.createElement('li');
                              li.innerText = '첨부파일 없음';
                              detailFilesUl.appendChild(li);
                            }





                            // 작성자 본인인 경우에만 수정/삭제 버튼 보이기
                            // currentUserId는 위에서 정의된 전역변수
                            const detailButtonsContainer = document.querySelector('#eventDetailModal .header-actions');
                            const editBtn = detailButtonsContainer.querySelector('.edit-button');
                            const deleteBtn = detailButtonsContainer.querySelector('.delete-button');

                            if (event.userId === currentUserId) {
                                if (editBtn) editBtn.style.display = 'block';
                                if (deleteBtn) deleteBtn.style.display = 'block';
                            } else {
                                if (editBtn) editBtn.style.display = 'none';
                                if (deleteBtn) deleteBtn.style.display = 'none';
                            }

                            // 수정 모달 띄울 때 이 정보 활용할 수 있게 전역 변수 저장
                            window.selectedEventData = data;
                            document.getElementById('eventDetailModal').style.display = 'flex'; // 모달 표시

                        })
                        .catch(err => {
                            console.error(err);
                            alert("일정 정보를 조회하는데 실패했습니다.");
                        });
                }
            });

            calendar.render();

            // 이전/다음 월 이동 버튼 연결
            document.getElementById('prevMonthBtn').addEventListener('click', function () {
                calendar.prev();
                updateMonthText(calendar);
            });
            document.getElementById('nextMonthBtn').addEventListener('click', function () {
                calendar.next();
                updateMonthText(calendar);
            });
            // 초기 월 텍스트 업데이트
            updateMonthText(calendar);
            function updateMonthText(cal) {
                const currentDate = cal.getDate();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                document.getElementById('currentMonthText').innerText = `${year}년 ${month}월`;
            }

            // FullCalendar headerToolbar 버튼을 숨기고 커스텀 버튼 사용
            calendar.setOption('headerToolbar', {
                left: '', // 기본 prev, next, today 버튼 숨김
                center: '', // 기본 타이틀 숨김
                right: '' // 기본 view 버튼 숨김
            });
        });

        // Date 객체를 원하는 형식의 문자열로 포맷하는 헬퍼 함수
        function formatDate(date, format) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][date.getDay()];
            let hours24 = date.getHours();
            let hours12 = hours24 % 12;
            hours12 = hours12 ? hours12 : 12;
            const minutes = date.getMinutes();
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
            const ampm = hours24 >= 12 ? '오후' : '오전';

            return format
                .replace('yyyy', year)
                .replace('M', month)
                .replace('d', day)
                .replace('E', dayOfWeek)
                .replace('HH', hours24 < 10 ? '0' + hours24 : hours24)
                .replace('H', hours24)
                .replace('hh', hours12 < 10 ? '0' + hours12 : hours12)
                .replace('h', hours12)
                .replace('m', formattedMinutes)
                .replace('a', ampm);
        }


        // ====== 일정 추가 모달 함수 (기존 calendar.html 스크립트에서 가져옴) ======
        function closeCreateEventModal() {
            document.getElementById('createEventModal').style.display = 'none';
        }

        function saveEvent() {
            const form = document.getElementById("eventForm");

            const formData = new FormData();
            // userId랑 workspaceCd는 임시로 지정해놨어요
            const requestBody = {
                userId: currentUserId, // 전역 currentUserId 사용
                workspaceCd: workspaceCd,
                title: form.title.value,
                description: form.description.value,
                startDatetime: form.startDatetime.value, // id 변경됨
                endDatetime: form.endDatetime.value,     // id 변경됨
                color: form.color.value,
                isShared: form.isShared ? form.isShared.value : '0',
                progressStatus: "TODO", // 새 일정은 기본 TODO로 가정 (폼에 없음)
                priority: form.priority.value,
                notifyTime: parseInt(form.notification.value) // 숫자로 변환
            };

            formData.append("request", new Blob([JSON.stringify(requestBody)], { type: "application/json" }));

            const attendenceIds = document.querySelectorAll('input[name="attendenceIds"]:checked');
            attendenceIds.forEach(cb => {
                formData.append("attendenceIds", cb.value);
            });

            selectedFiles.forEach(file => {
                formData.append("files", file);
            });

            fetch('/api/calendar/personal', {
                method: 'POST',
                body: formData
            })
                .then(res => {
                    if (!res.ok) throw new Error('등록 실패');
                    return res.text();
                })
                .then(data => {
                    alert("일정 등록 성공!");
                    location.reload(); // 캘린더 새로고침
                })
                .catch(err => {
                    console.error(err);
                    alert("서버 오류 발생");
                });

            closeCreateEventModal();
        }

        /* "종일" 체크박스 로직 (createEventModal 내) */
        const createAllDayCheckbox = document.getElementById('allDay');
        const createStartDatetimeInput = document.getElementById('startDatetime');
        const createEndDatetimeInput = document.getElementById('endDatetime');

        createAllDayCheckbox.addEventListener('change', function () {
            if (this.checked) {
                const startDate = new Date(createStartDatetimeInput.value);
                startDate.setHours(0, 0, 0, 0);

                const endDate = new Date(startDate);
                endDate.setHours(23, 59, 59, 999);

                createStartDatetimeInput.value = formatDateToLocalISO(startDate);
                createEndDatetimeInput.value = formatDateToLocalISO(endDate);
            }
        });

        function formatDateToLocalISO(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }


        let selectedFiles = [];

        document.getElementById('fileUpload').addEventListener('change', function() {
            const insertedFilesUl = document.getElementById('insertedFiles');

            // 새로 선택한 파일들을 배열에 추가
            for (let i = 0; i < this.files.length; i++) {
                selectedFiles.push(this.files[i]);
            }

            updateFileListUI();

            // input 초기화해서 같은 파일 다시 선택 가능하게 함
            this.value = '';
        });

        function updateFileListUI() {
            const insertedFilesUl = document.getElementById('insertedFiles');
            insertedFilesUl.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';

                const span = document.createElement('span');
                span.textContent = file.name;

                const removeButton = document.createElement('button');
                removeButton.textContent = '❌';
                removeButton.type = 'button';
                removeButton.className = 'file-delete-button';
                removeButton.style.background = 'transparent';
                removeButton.style.border = 'none';
                removeButton.style.color = '#ff6b6b';
                removeButton.style.cursor = 'pointer';

                // 클릭하면 배열에서 삭제
                removeButton.addEventListener('click', () => {
                    selectedFiles.splice(index, 1);
                    updateFileListUI(); // 리스트 다시 그리기
                });

                li.appendChild(span);
                li.appendChild(removeButton);
                insertedFilesUl.appendChild(li);
            });
        }


        // ====== 일정 상세 모달 함수 (기존 calendar.html 스크립트에서 가져옴) ======
        function closeDetailModal() {
            document.getElementById('eventDetailModal').style.display = 'none';
        }

        // ====== 파일 다운로드 함수 (기존 calendar.html 스크립트에서 가져옴) ======
        function downloadFromS3(fileUrl, fileName) {
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) throw new Error("다운로드 실패");
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(err => {
                    console.error(err);
                    alert("파일 다운로드 중 오류가 발생했습니다.");
                });
        }

        // ====== 일정 수정 모달 함수 (기존 calendar.html 스크립트에서 가져옴) ======
        let deletedFileIds = []; // 전역 변수로 관리

        function openUpdateModal() {
            closeCreateEventModal();
            closeDetailModal();

            const data = window.selectedEventData;
            if (!data) {
                alert("수정할 이벤트 데이터가 없습니다.");
                return;
            }

            const eventData = data.event;

            // 수정 폼에 기존 값 불러오기
            document.getElementById('update-eventCd').value = eventData.eventCd;
            document.getElementById('update-title').value = eventData.title || '';
            document.getElementById('update-description').value = eventData.description || '';
            document.getElementById('update-startDatetime').value = eventData.startDatetime ? formatDateToLocalISO(new Date(eventData.startDatetime)) : '';
            document.getElementById('update-endDatetime').value = eventData.endDatetime ? formatDateToLocalISO(new Date(eventData.endDatetime)) : '';
            document.getElementById('update-color').value = eventData.color || '#0066CC';
            document.getElementById('update-priority').value = eventData.priority || 'NORMAL';
            document.getElementById('update-progressStatus').value = eventData.progressStatus || 'TODO';
            document.getElementById('update-isShared').value = eventData.isShared === "1" ? '1' : '0'; // '1' 또는 '0'으로 설정
            document.getElementById('update-location').value = data.location || ''; // 위치 필드 추가

            // 알림 시간 설정 (notification 매핑)
            let notifyTimeVal = eventData.notifyTime;
            // 캘린더에서 넘어온 notifyTime (분 단위 숫자)을 select 옵션의 value와 매칭
            let notificationSelect = document.getElementById('update-notification');
            let foundOption = false;
            for (let i = 0; i < notificationSelect.options.length; i++) {
                if (notificationSelect.options[i].value == notifyTimeVal) {
                    notificationSelect.value = notifyTimeVal;
                    foundOption = true;
                    break;
                }
            }
            if (!foundOption) { // 매칭되는 옵션이 없으면 기본값으로 설정 (예: 알림 없음)
                notificationSelect.value = '0';
            }

            // 참가자 체크박스 채우기
              const membersContainer = document.getElementById('update-workspaceMembers');
              membersContainer.innerHTML = '';

              fetch(`/api/getMembers?workspaceCd=${workspaceCd}`)
                .then(res => {
                  if (!res.ok) throw new Error("멤버정보 조회 실패");
                  return res.json();
                })
                .then(membersData => {
                  // 이미 참가중인 사람들
                  const attendenceIds = (data.attendences || []).map(m => m.userId);

                  membersData.forEach(member => {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'attendenceIds';
                    checkbox.value = member.userId;
                    checkbox.id = 'update-' + member.userId;

                    // 이미 체크된 사람 표시
                    if (attendenceIds.includes(member.userId)) {
                      checkbox.checked = true;
                    }

                    // 본인은 숨김
                    if (member.userId === currentUserId) {
                      checkbox.checked = true;
                      checkbox.style.display = 'none';
                    }

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = member.userNickname;

                    if (member.userId === currentUserId) {
                      label.style.display = 'none';
                    }

                    membersContainer.appendChild(checkbox);
                    membersContainer.appendChild(label);
                    membersContainer.appendChild(document.createElement('br'));
                  });
                });


            // 기존 파일 목록 불러오기 및 삭제 버튼
            const updateFilesUl = document.getElementById('updateFiles');
            updateFilesUl.innerHTML = ''; // 초기화
            deletedFileIds = []; // 삭제할 파일 ID 목록 초기화

            if (data.fileList && data.fileList.length > 0) {
                data.fileList.forEach(file => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                  <span>${file.fileNm}</span>
                  <button type="button" class="file-delete-button" data-file-id="${file.fileId}" onclick="markFileForDeletion('${file.fileId}', this)">파일 삭제</button>
              `;
                    updateFilesUl.appendChild(li);
                });
            } else {
                updateFilesUl.innerHTML = '<li>기존 첨부파일 없음</li>';
            }

            document.getElementById('updateEventModal').style.display = 'flex'; // 모달 표시
        }

        // 파일 삭제 버튼 눌렀을 때 삭제할 파일 아이디 임시로 저장
        function markFileForDeletion(fileId, buttonElement) {
            if (!deletedFileIds.includes(fileId)) { // 중복 추가 방지
                deletedFileIds.push(fileId);
            }
            buttonElement.closest('li').style.textDecoration = 'line-through';
            buttonElement.disabled = true; // 버튼 비활성화
            buttonElement.innerText = '삭제 예정';
        }

        function closeUpdateModal() {
            document.getElementById('updateEventModal').style.display = 'none';
            deletedFileIds = []; // 모달 닫을 때 삭제 목록 초기화
            document.getElementById('updateEventForm').reset(); // 폼 초기화
            document.getElementById('updateFiles').innerHTML = ''; // 파일 목록 초기화
        }

        // 수정사항 저장용
        function submitUpdateEvent() {
            const form = document.getElementById('updateEventForm');
            const formData = new FormData();
            const eventCd = document.getElementById('update-eventCd').value;

            const requestBody = {
                eventCd: eventCd, // 이미 히든 필드에서 가져옴
                title: form.title.value,
                description: form.description.value,
                startDatetime: form.startDatetime.value, // id 변경됨
                endDatetime: form.endDatetime.value,     // id 변경됨
                color: form.color.value,
                priority: form.priority.value,
                progressStatus: document.getElementById('update-progressStatus').value,
                isShared: form.isShared ? form.isShared.value : '0',
                userId: currentUserId, // 현재 유저 ID 사용 (작성자)
                workspaceCd: workspaceCd, // 임시 워크스페이스 코드
                location: document.getElementById('update-location').value, // 위치 필드 추가
                notifyTime: parseInt(form.notification.value) // 숫자로 변환
            };

            // 참가자 체크박스 값 추가
            const attendenceIds = document.querySelectorAll('#update-workspaceMembers input[name="attendenceIds"]:checked');
            attendenceIds.forEach(cb => {
              formData.append("attendenceIds", cb.value);
            });

            formData.append("request", new Blob([JSON.stringify(requestBody)], { type: "application/json" }));
            formData.append("deletedFileIds", new Blob([JSON.stringify(deletedFileIds)], { type: "application/json" }));

            // 추가된 파일이 있을 경우
            const fileInput = form.querySelector('input[name="files"]');
            if (fileInput && fileInput.files.length > 0) {
                for (const file of fileInput.files) {
                    formData.append("files", file);
                }
            }

            fetch(`/api/calendar/personal/events/${eventCd}`, {
                method: 'PUT',
                body: formData
            })
                .then(res => {
                    if (!res.ok) throw new Error("수정 실패");
                    return res.text();
                })
                .then(data => {
                    alert("일정이 수정되었습니다!");
                    closeUpdateModal();
                    location.reload(); // 또는 FullCalendar 이벤트 갱신
                })
                .catch(err => {
                    console.error(err);
                    alert("수정에 실패했습니다.");
                });
        }

        // ====== 일정 삭제 함수 (기존 calendar.html 스크립트에서 가져옴) ======
        function deleteEvent() {
            const confirmDelete = confirm("정말로 이 일정을 삭제하시겠습니까?");
            if (confirmDelete) {
                const eventCd = window.selectedEventData?.event?.eventCd;
                if (!eventCd) {
                    alert("삭제할 이벤트 코드가 없습니다.");
                    return;
                }

                fetch(`/api/calendar/personal/events/${eventCd}`, {
                    method: 'DELETE'
                })
                    .then(res => {
                        if (!res.ok) throw new Error("삭제 실패");
                        return res.text();
                    })
                    .then(data => {
                        alert("일정이 삭제되었습니다!");
                        closeDetailModal();
                        location.reload(); // 캘린더 새로고침
                    })
                    .catch(err => {
                        console.error(err);
                        alert("삭제 중 오류가 발생했습니다.");
                    });
            } else {
                console.log("삭제 취소됨");
            }
        }
        /*]]>*/
    </script>
</body>

</html>
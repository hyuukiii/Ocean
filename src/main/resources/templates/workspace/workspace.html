<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkSpace List</title>
    <!-- 브라우저용 -->
    <!--
    <link rel="stylesheet" href="/src/main/resources/static/css/Header.css">
    <link rel="stylesheet" href="/src/main/resources/static/css/spaceListPage.css">
    -->

    <!-- 서버용 -->
    <link rel="stylesheet" th:href="@{/css/Header.css}">
    <link rel="stylesheet" th:href="@{/css/spaceListPage.css}">
</head>
<body>
<header class="header">
    <div class="logo" onclick="location.href='/'">
        <div class="logo-icon">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 50 Q30 20 50 30 T90 20" stroke="#4facfe" stroke-width="8" fill="none" stroke-linecap="round"/>
                <path d="M10 70 Q30 40 50 50 T90 40" stroke="#00f2fe" stroke-width="8" fill="none" stroke-linecap="round"/>
            </svg>
        </div>
        Ocean WorkSpace
    </div>
</header>

<div class="middle">
    <div class="space-container">
        <h2 class="middle-text">WorkSpace List</h2>

        <form th:action="@{/workspace/favorite}" method="post" class="space-list-form">
            <div class="space-list">
                <!-- Thymeleaf 반복문으로 워크스페이스 목록 표시 -->
                <div th:each="ws : ${workspaceList}" class="space-item" th:attr="data-id=${ws.workspaceCd}" onclick="goToDetail(this)">
                    <input type="checkbox" name="selectedWorkspaces" th:value="${ws.workspaceCd}" onclick="event.stopPropagation()">

                    <div class="space-profile">
                        <img th:src="@{'/images/' + ${ws.workspaceImg}}" width="100" height="100" th:if="${ws.workspaceImg != null}">
                        <svg th:unless="${ws.workspaceImg != null}" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="45" th:fill="${ws.favorite == 1 ? '#ff6b6b' : '#4facfe'}"/>
                            <text x="50" y="70" text-anchor="middle" fill="white" font-size="40" th:text="${ws.workspaceNm.substring(0,1)}"></text>
                        </svg>
                        <!-- 하트 표시 -->
                        <span th:if="${ws.favorite != null and ws.favorite == 1}" class="favorite-heart">❤️</span>
                    </div>

                    <div class="space-info">
                        <div class="space-text" th:text="${ws.workspaceNm}">워크스페이스명</div>
                        <div class="invite-code" th:text="'초대코드: ' + ${ws.inviteCd}">초대코드</div>
                    </div>
                </div>

                <!-- 워크스페이스가 없는 경우 -->
                <div th:if="${workspaceList == null or #lists.isEmpty(workspaceList)}" class="no-workspace">
                    워크스페이스가 없습니다.
                </div>
            </div>

            <div class="favorite-buttons">
                <button type="submit" name="action" value="favorite" class="btn-favorite">찜하기</button>
                <button type="submit" name="action" value="unfavorite" class="btn-unfavorite">찜 해제</button>
            </div>
        </form>
    </div>
</div>

<!-- 하단 버튼 그룹 -->
<div class="button-group">
    <button class="btn-create" onclick="location.href='/workspace/create'">Create Space</button>
    <button class="btn-join" onclick="location.href='/invitations/join'">Join Space</button>
</div>
</body>

<script>

    // 토큰 갱신 함수
    async function refreshAccessToken() {
        try {
            const response = await fetch('/api/auth/refresh', {
                method: 'POST',
                credentials: 'include' // 쿠키(리프레시 토큰) 포함
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.accessToken);
                return data.accessToken;
            } else {
                // 리프레시 토큰도 만료됨 - 로그인 페이지로
                window.location.href = '/login';
                return null;
            }
        } catch (error) {
            console.error('토큰 갱신 실패:', error);
            window.location.href = '/login';
            return null;
        }
    }

    // API 요청 래퍼 함수
    async function apiRequest(url, options = {}) {
        let token = localStorage.getItem('accessToken');

        // 첫 번째 시도
        let response = await fetch(url, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': 'Bearer ' + token
            }
        });

        // 401 에러면 토큰 갱신 후 재시도
        if (response.status === 401) {
            token = await refreshAccessToken();
            if (token) {
                response = await fetch(url, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': 'Bearer ' + token
                    }
                });
            }
        }

        return response;
    }

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            // 토큰이 없으면 로그인 페이지로
            window.location.href = '/login';
            return;
        }

        // 모든 AJAX 요청에 토큰 추가 (jQuery 사용 시)
        if (window.jQuery) {
            $.ajaxSetup({
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        // 토큰 만료 시 갱신
                        refreshAccessToken().then(newToken => {
                            if (newToken) {
                                // 원래 요청 재시도
                                this.headers = {'Authorization': 'Bearer ' + newToken};
                                $.ajax(this);
                            }
                        });
                    }
                }
            });
        }
    });

    function goToDetail(elem) {
        const workspaceCd = elem.getAttribute('data-id');
        location.href = `/workspace/enter/${workspaceCd}`;
    }
</script>

</html>
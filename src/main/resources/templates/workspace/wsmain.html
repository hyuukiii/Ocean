<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ocean</title>

    <link rel="stylesheet" th:href="@{/css/lnb.css}">
    <link rel="stylesheet" th:href="@{/css/wsmain.css}">
    <link rel="stylesheet" th:href="@{/css/rnb.css}">
    <link rel="stylesheet" th:href="@{/css/invite.css}">
    <link rel="stylesheet" th:href="@{/css/profile-modal.css}">

    <style>
        body {
          margin: 0;
          display: flex;
        }
    </style>
</head>
<body>

<!-- ✅ 왼쪽 사이드바 (Thymeleaf fragment 유지) -->
<div th:replace="~{fragments/lnb :: lnbFragment}"></div>

<!-- 메인 콘텐츠 -->
<div class="main">
    <div class="top-banner">
        <div class="title">프로젝트 마감까지</div>
        <div class="d-day">D-21</div>
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <div class="date">6월 10일 화요일</div>
    </div>

    <div class="main-section">
        <div class="schedule">
            <h2>오늘의 일정</h2>
            <div class="event"><span class="dot blue"></span> 10:00 개발 스프린트 회의</div>
            <div class="event"><span class="dot purple"></span> 12:00 디자인 리뷰</div>
            <div class="event"><span class="dot green"></span> 14:00 신입사원 온보딩</div>
        </div>

        <div class="activity">
            <h2>최근활동</h2>
            <div class="log"><span class="badge">윤</span> 윤현기님이 새로운 미팅룸을 잡았어요</div>
            <div class="log"><span class="badge">권</span> 권지언님이 일정을 수정했어요</div>
            <div class="log"><span class="badge">임</span> 임형택님이 문서를 업로드했어요</div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="stats">
            <div class="stat-box"><div class="big">24</div><div>새로운 일정</div></div>
            <div class="stat-box"><div class="big">8</div><div>완료된 일정</div></div>
            <div class="stat-box"><div class="big">78</div><div>총 활동 시간</div></div>
        </div>
        <div class="quote">
            대부분의 프로젝트는 기술이 아니라<br>인적 자원과 프로젝트 관리의 문제로 실패한다.<br>
            <b>- R. Thomsett</b>
        </div>
    </div>
</div>

<!-- ✅ 오른쪽 사이드바: static + fetch 방식 -->
<div id="rnbContainer" th:data-workspace-cd="${workspaceCd}"></div>

<!-- ✅ 모달들을 static HTML로 fetch 로딩 -->
<div id="miniProfileContainer"></div>
<div id="profileModalContainer"></div>
<div id="inviteModalContainer"></div>

<!-- ✅ JS: fetch 로딩 및 동작 처리 -->
<script th:src="@{/js/rnb-fetch.js}" defer></script>
<script th:src="@{/js/profile-modal.js}" defer></script>
<script th:src="@{/js/mini-profile.js}" defer></script>
<script th:src="@{/js/token.js}" defer></script>

<!-- ✅ 사용자 정보 Thymeleaf에서 JavaScript로 넘기기 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const userId = /*[[${userId}]]*/ '';
    const userName = /*[[${userName}]]*/ '';
    const workspaceCd = /*[[${workspaceCd}]]*/ '';

    if (userId) {
      localStorage.setItem('userId', userId);
    }

    function openSketchMeeting() {
      const user = { id: userId, name: userName };
      const roomId = 'sketch-' + Date.now() + '-' + Math.random().toString(36).substr(2, 8);
      const mediaServerUrl = /*[[${@environment.getProperty('media.server.url')}]]*/ 'https://localhost:3001';
      const params = new URLSearchParams({
        roomId,
        workspaceId: workspaceCd,
        peerId: user.id,
        displayName: user.name,
        meetingType: 'sketch'
      });
      const meetingUrl = `${mediaServerUrl}/ocean-video-chat-complete.html?${params}`;
      const windowFeatures = 'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no';
      const meetingWindow = window.open(meetingUrl, 'SketchMeeting', windowFeatures);

      if (!meetingWindow) {
        alert('팝업이 차단되었습니다. 팝업 차단을 해제해주세요.');
        window.location.href = meetingUrl;
      }
    }

    function getSketchMeetingInviteLink(roomId) {
      const baseUrl = window.location.origin;
      return `${baseUrl}/sketch/join?roomId=${roomId}`;
    }

    window.currentWorkspaceCd = workspaceCd;
    /*]]>*/
</script>

</body>
</html>

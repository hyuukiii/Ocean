<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>저장된 장소 확인</title>

  <link rel="stylesheet" th:href="@{/css/placeList.css}">
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1a9ca55e1cb213f15176c2b99a62db20&libraries=services"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="app-container">
  <nav class="sidebar">
    <div class="sidebar-menu">
      <div class="menu-item">
        <span class="material-symbols-outlined">home</span>
        <span>홈</span>
      </div>
      <div class="menu-item">
        <span class="material-symbols-outlined">calendar_month</span>
        <span>팀 캘린더</span>
      </div>
      <div class="menu-item">
        <span class="material-symbols-outlined">person_pin</span>
        <span>개인 캘린더</span>
      </div>
      <div class="menu-item active">
        <span class="material-symbols-outlined">pin_drop</span>
        <span>모임 장소</span>
      </div>
      <div class="menu-item">
        <span class="material-symbols-outlined">chat</span>
        <span>스케치 회의</span>
      </div>
    </div>
    <div class="sidebar-footer">
      <div class="menu-item">
        <span class="material-symbols-outlined">menu</span>
      </div>
    </div>
  </nav>
  <main class="main-content">
    <div class="place-list-container">
      <div class="place-list-header">
        <div>일자/시간</div>
        <div>작성자</div>
        <div>제목</div>
        <div>장소 명</div>
      </div>
      <div class="place-list" id="placeList">
        <div class="place-item" th:each="place, iterStat : ${places}"
             th:data-place-json="${placesJson[iterStat.index]}">
          <div th:text="${place.created_at != null ? #temporals.format(place.created_at, 'yy.MM.dd HH:mm') : ''}">25.06.10 16:30</div>
          <div th:text="${place.created_by}">윤현기</div>
          <div th:text="${place.place_name}">조금 긴 제목일 경우 타이핑 되는 방식</div>
          <div th:text="${place.address_name}">조금 긴 장소명일 경우 타이핑 되는 방식</div>
        </div>
      </div>
    </div>
    <button class="add-schedule-btn" id="addScheduleBtn">+ 일정 추가하기</button>
  </main>

  <aside class="detail-panel">
    <div class="empty-view" id="emptyView">
      <span class="material-symbols-outlined">deselect</span>
      <span>선택된 일정이 없습니다.</span>
    </div>

    <div class="detail-view" id="detailView">
      <div class="detail-header">
        <h2 id="detailTitle">장소 이름</h2>
        <div class="detail-actions">
          <span class="material-symbols-outlined">delete</span>
          <span class="material-symbols-outlined">edit</span>
        </div>
      </div>
      <div class="detail-meta">
        <div class="user-icon" id="detailUserIcon"></div>
        <div class="user-info">
          <span class="user-name" id="detailUserName">작성자</span>
          <div class="meta-grid">
            <span>일자</span><span id="detailDate"></span>
            <span>시간</span><span id="detailTime"></span>
            <span>주소</span><span id="detailAddress"></span>
          </div>
        </div>
      </div>
      <div id="detail_map"></div>
      <div class="detail-content">
        내용 출력 공간
      </div>
    </div>

    <div class="add-schedule-view" id="addScheduleView">
      <div class="detail-header">
        <textarea placeholder="제목 기입란"></textarea>
        <div class="detail-actions">
          <button type="button" class="action-button" id="cancelAddBtn">
            <span class="material-symbols-outlined">close</span>
            <span class="button-text">취소하기</span>
          </button>
          <button type="button" class="action-button" id="saveScheduleBtn">
            <span class="material-symbols-outlined">save</span>
            <span class="button-text">저장하기</span>
          </button>
        </div>
      </div>
      <div class="detail-meta">
        <div class="user-icon">?</div>
        <div class="user-info">
          <span class="user-name">사용자 이름</span>
          <span class="meta-text">일정 및 장소를 선택해주세요.</span>
        </div>
      </div>
      <div class="add-form-container">
        <div class="form-item">
          <label for="add_keyword">주소 검색</label>
          <div class="search-box">
            <input type="text" id="add_keyword" placeholder="장소, 주소 검색">
            <button id="placeSearchBtn">검색</button>
          </div>
        </div>
        <div id="add_map"></div>
        <ul id="add_placesList"></ul>
        <div id="add_pagination"></div>
      </div>
      <div class="add-content-area">
        <textarea placeholder="내용 입력 공간"></textarea>
      </div>
      <div class="add-bottom-bar">
        <input type="text" id="add_place_name" placeholder="선택된 장소 이름">
        <button id="deleteMarkerBtn">마커 삭제</button>
      </div>
    </div>
  </aside>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', function() {

    // --- 1. 공통 변수 및 뷰 제어 ---
    // [수정] id가 부여된 버튼 요소들을 가져옵니다.
    const emptyView = document.getElementById('emptyView');
    const detailView = document.getElementById('detailView');
    const addScheduleView = document.getElementById('addScheduleView');
    const addScheduleBtn = document.getElementById('addScheduleBtn');
    const cancelAddBtn = document.getElementById('cancelAddBtn');
    const placeItems = document.querySelectorAll('.place-item');
    const saveScheduleBtn = document.getElementById('saveScheduleBtn');
    const placeSearchBtn = document.getElementById('placeSearchBtn');
    const deleteMarkerBtn = document.getElementById('deleteMarkerBtn');

    // --- 뷰 전환 로직 및 이벤트 리스너 등록 ---
    addScheduleBtn.addEventListener('click', function() {
      showView('add');
      if (!addMap) { initAddMap(); }
    });
    cancelAddBtn.addEventListener('click', function() { showView('empty'); });

    // [수정] 가져온 요소에 이벤트 리스너를 등록합니다.
    saveScheduleBtn.addEventListener('click', submitLocation);
    placeSearchBtn.addEventListener('click', searchPlaces);
    deleteMarkerBtn.addEventListener('click', deleteUserMarker);


    function showView(viewName) {
      emptyView.style.display = 'none';
      detailView.style.display = 'none';
      addScheduleView.style.display = 'none';
      if (viewName === 'detail') detailView.style.display = 'flex';
      else if (viewName === 'add') addScheduleView.style.display = 'flex';
      else emptyView.style.display = 'flex';
    }

    // --- 2. 상세 보기(Detail View) 관련 로직 ---
    let detailMap = null;
    let detailMarker = null;

    function initDetailMap() {
      const mapContainer = document.getElementById('detail_map');
      if (!mapContainer) return;
      const mapOption = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 };
      detailMap = new kakao.maps.Map(mapContainer, mapOption);
      detailMarker = new kakao.maps.Marker({ position: detailMap.getCenter() });
      detailMarker.setMap(detailMap);
    }

    function updateDetailView(place) {
      if (!detailMap) return;

      const detailTitle = document.getElementById('detailTitle');
      const detailUserIcon = document.getElementById('detailUserIcon');
      const detailUserName = document.getElementById('detailUserName');
      const detailDate = document.getElementById('detailDate');
      const detailTime = document.getElementById('detailTime');
      const detailAddress = document.getElementById('detailAddress');

      detailTitle.textContent = place.place_name;
      detailUserName.textContent = place.created_by;
      detailUserIcon.textContent = place.created_by ? place.created_by.substring(0, 1) : '?';
      detailAddress.textContent = place.address_name;

      if (place.created_at) {
        const date = new Date(place.created_at);
        detailDate.textContent = `${date.getFullYear().toString().slice(2)}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`;
        detailTime.textContent = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
      } else {
        detailDate.textContent = '-';
        detailTime.textContent = '-';
      }

      const position = new kakao.maps.LatLng(place.lat, place.lng);
      detailMap.setCenter(position);
      detailMarker.setPosition(position);
    }

    placeItems.forEach(item => {
      // [개선] 여기도 addEventListener로 변경하여 일관성을 맞춥니다.
      item.addEventListener('click', function() {
        placeItems.forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        const placeData = this.getAttribute('data-place-json');
        const place = JSON.parse(placeData);
        showView('detail');
        updateDetailView(place);
      });
    });

    // --- 3. 일정 추가(Add Schedule) 관련 로직 ---
    let addMap = null;
    let addPs = null;
    let addGeocoder = null;
    let addMarkers = [];
    let addUserMarker = null;
    let userSelectedLatLng = null;
    let userSelectedPlaceId = null;
    let userSelectAddressName = null;

    function initAddMap() {
        const mapContainer = document.getElementById('add_map');
        const mapOption = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 3 };
        addMap = new kakao.maps.Map(mapContainer, mapOption);
        addPs = new kakao.maps.services.Places();
        addGeocoder = new kakao.maps.services.Geocoder();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                addMap.setCenter(new kakao.maps.LatLng(lat, lng));
            });
        }

        kakao.maps.event.addListener(addMap, 'click', function(mouseEvent) {
            const latlng = mouseEvent.latLng;
            userSelectedLatLng = latlng;
            userSelectedPlaceId = null;
            if (addUserMarker) { addUserMarker.setMap(null); }
            addUserMarker = new kakao.maps.Marker({ position: latlng, map: addMap });
            addMap.setCenter(latlng);
            addGeocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    userSelectAddressName = result[0].address.address_name;
                    document.getElementById("add_place_name").value = userSelectAddressName;
                } else {
                    userSelectAddressName = "주소 정보 없음";
                    document.getElementById("add_place_name").value = "선택한 위치";
                }
            });
        });
    }

    // [수정] window.searchPlaces 대신 지역(local) 함수로 변경
    function searchPlaces() {
      const keyword = document.getElementById('add_keyword').value;
      if (!keyword.trim()) return alert('키워드를 입력해주세요!');
      addPs.keywordSearch(keyword, placesSearchCB);
    }

    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {
        displayPlaces(data);
        displayPagination(pagination);
      } else {
        alert('검색 결과가 없습니다.');
      }
    }

    function displayPlaces(places) {
      const listEl = document.getElementById('add_placesList');
      const bounds = new kakao.maps.LatLngBounds();
      listEl.innerHTML = "";
      removeAddMarker();

      places.forEach(place => {
        const placePosition = new kakao.maps.LatLng(place.y, place.x);
        const marker = createAddMarker(placePosition);
        const itemEl = getListItem(place);
        bounds.extend(placePosition);

        // [개선] IIFE 없이, 그리고 .onclick 대신 addEventListener 사용
        kakao.maps.event.addListener(marker, 'click', () => handlePlaceSelect(marker, place, placePosition));
        itemEl.addEventListener('click', () => handlePlaceSelect(marker, place, placePosition));

        listEl.appendChild(itemEl);
      });
      addMap.setBounds(bounds);
    }

    function handlePlaceSelect(marker, place, position) {
      addMap.setCenter(position);
      addMap.setLevel(3);

       if (addUserMarker) {
    addUserMarker.setPosition(position);
    addUserMarker.setMap(addMap); // 혹시 삭제되었을 경우를 대비해 다시 지도에 표시
  } else {
    addUserMarker = new kakao.maps.Marker({
        position: position,
        map: addMap
    });
  }
  userSelectedLatLng = position;
  userSelectedPlaceId = place.id;
  userSelectAddressName = place.address_name || "주소 정보 없음";
  document.getElementById("add_place_name").value = place.place_name;
}

    function getListItem(place) {
      const el = document.createElement('li');
      el.innerHTML = `<span>${place.place_name}</span><p>${place.address_name}</p>`;
      return el;
    }

    function createAddMarker(position) {
      const marker = new kakao.maps.Marker({ map: addMap, position: position });
      addMarkers.push(marker);
      return marker;
    }

    function removeAddMarker() {
      addMarkers.forEach(marker => marker.setMap(null));
      addMarkers = [];
    }

    // [수정] window.deleteUserMarker 대신 지역 함수로 변경
    function deleteUserMarker() {
      if (addUserMarker) {
        addUserMarker.setMap(null);
        addUserMarker = null;
        userSelectedLatLng = null;
        userSelectedPlaceId = null;
        userSelectAddressName = null;
        document.getElementById("add_place_name").value = "";
        alert("마커가 삭제되었습니다.");
      }
    }

function displayPagination(pagination) {
  const paginationEl = document.getElementById('add_pagination');
  paginationEl.innerHTML = ''; // 이전 페이지네이션 삭제

  const fragment = document.createDocumentFragment();

  // '처음' 버튼 (옵션)
  // '이전' 버튼 생성
  const prevBtn = document.createElement('a');
  prevBtn.innerHTML = '&lt;'; // < 아이콘
  if (pagination.current === 1) {
    prevBtn.classList.add('disabled');
  } else {
    prevBtn.addEventListener('click', () => pagination.gotoPage(pagination.current - 1));
  }
  fragment.appendChild(prevBtn);

  // 페이지 번호 버튼 생성
  for (let i = 1; i <= pagination.last; i++) {
    const el = document.createElement('a');
    el.href = "#";
    el.innerHTML = i;
    if (i === pagination.current) {
      el.className = 'on';
    } else {
      el.addEventListener('click', function(e) {
        e.preventDefault(); // a 태그의 기본 동작 방지
        pagination.gotoPage(i);
      });
    }
    fragment.appendChild(el);
  }

  // '다음' 버튼 생성
  const nextBtn = document.createElement('a');
  nextBtn.innerHTML = '&gt;'; // > 아이콘
  if (pagination.current === pagination.last) {
    nextBtn.classList.add('disabled');
  } else {
    nextBtn.addEventListener('click', () => pagination.gotoPage(pagination.current + 1));
  }
  fragment.appendChild(nextBtn);

  // '마지막' 버튼 (옵션)

  paginationEl.appendChild(fragment);
}

    // [수정] window.submitLocation 대신 지역 함수로 변경
    function submitLocation() {
      alert("저장 기능이 호출되었습니다.");
    }

    // --- 페이지 로드 시 초기 실행 ---
    initDetailMap();

  });
  /*]]>*/
</script>
</body>
</html>
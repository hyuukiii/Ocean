<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>저장된 장소 확인</title>

  <link rel="stylesheet" th:href="@{/css/placeList.css}">
  <link rel="stylesheet" th:href="@{/css/lnb.css}">
  <link rel="stylesheet" th:href="@{/css/rnb.css}">
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=1a9ca55e1cb213f15176c2b99a62db20&libraries=services"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>

<div class="app-container">
  <nav>
    <div th:replace="~{fragments/lnb :: lnbFragment}"></div>
  </nav>
  <main class="main-content">
    <div class="place-list-container">
      <div class="place-list-header">
        <div>일자</div>
        <div>약속 시간</div>
        <div>장소명</div>
        <div>주소</div>
        <div>작성자</div>
      </div>

      <div class="place-list" id="placeList">
        <div th:if="${#lists.isEmpty(places)}" class="empty-list-message">
          <span>저장된 장소가 없습니다.</span>
        </div>

        <div th:each="place, iterStat : ${places}" class="place-item"
             th:attr="data-place-json=${placesJson[iterStat.index]}">

          <div th:text="${#temporals.format(place.startDatetime, 'yyyy-MM-dd')}"></div>
          <div th:text="${#temporals.format(place.startDatetime, 'HH:mm')}"></div>
          <div th:text="${place.placeNm}"></div>
          <div th:text="${place.address}"></div>
          <div th:text="${place.createdBy}"></div>
        </div>
      </div>
    </div>
    <button class="add-schedule-btn" id="addScheduleBtn">+ 일정 추가하기</button>
  </main>

  <aside class="detail-panel">
    <div class="empty-view" id="emptyView">
      <span class="material-symbols-outlined">deselect</span>
      <span>선택된 일정이 없습니다.</span>
    </div>

    <div class="detail-view" id="detailView">
      <div class="detail-header">
        <h2 id="detailTitle">장소 이름</h2>
        <div class="detail-actions">
          <span class="material-symbols-outlined">delete</span>
          <span class="material-symbols-outlined">edit</span>
        </div>
      </div>
      <div class="detail-meta">
        <div class="user-icon" id="detailUserIcon" style="background-image: url('/images/default-profile.png');"></div>
        <div class="user-info">
          <span class="user-name" id="detailUserName">작성자</span>
          <div class="meta-grid">
            <span>시작</span><span id="detailStartDate"></span>
            <span>종료</span><span id="detailEndDate"></span>
            <span>주소</span><span id="detailAddress"></span>
          </div>
        </div>
      </div>
      <div id="detail_map"></div>
      <div class="detail-content" id="detailContent">
        내용 출력 공간
      </div>
    </div>
    <div class="add-schedule-view" id="addScheduleView">
    </div>
  </aside>
  <div id="rnbContainer"></div>
  <div th:replace="~{fragments/rnb :: rnbFragment}"></div>
  <script th:src="@{/js/rnb-fetch.js}"></script>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', function() {

      const workspaceCd = /*[[${workspaceCd}]]*/ '';
      const userId = /*[[${userId}]]*/ '';

      if (!workspaceCd) {
          alert('워크스페이스 정보가 없습니다.');
          window.location.href = '/workspace';
          return;
      }
      const editBtn = document.querySelector('.detail-actions span:nth-child(2)');
const deleteBtn = document.querySelector('.detail-actions span:nth-child(1)');

      editBtn.addEventListener('click', () => {
          const selectedItem = document.querySelector('.place-item.selected');
          if (selectedItem) {
              const placeJson = selectedItem.getAttribute('data-place-json');
              const place = JSON.parse(placeJson);
              alert(`'${place.title}' 일정을 수정합니다.`);
              // 여기에 실제 수정 로직(예: 수정 폼으로 전환)을 구현하면 됩니다.
          } else {
              alert('수정할 일정을 선택해주세요.');
          }
      });

      deleteBtn.addEventListener('click', () => {
          const selectedItem = document.querySelector('.place-item.selected');
          if (selectedItem) {
              const placeJson = selectedItem.getAttribute('data-place-json');
              const place = JSON.parse(placeJson);
              if (confirm(`'${place.title}' 일정을 정말 삭제하시겠습니까?`)) {
                  alert('삭제되었습니다.');
                  // 여기에 실제 삭제 API를 호출하는 fetch 로직을 구현하면 됩니다.
              }
          } else {
              alert('삭제할 일정을 선택해주세요.');
          }
      });
      bindPlaceItemEvents();


      const emptyView = document.getElementById('emptyView');
      const detailView = document.getElementById('detailView');
      const addScheduleView = document.getElementById('addScheduleView');
      const addScheduleBtn = document.getElementById('addScheduleBtn');

      // --- 뷰 전환 로직 및 이벤트 리스너 ---
      addScheduleBtn.addEventListener('click', () => {
        showView('add');
        if (!addMap) initAddMap();
      });

      function showView(viewName) {
          emptyView.style.display = 'none';
          detailView.style.display = 'none';
          addScheduleView.style.display = 'none';
          if (viewName === 'detail') detailView.style.display = 'flex';
          else if (viewName === 'add') addScheduleView.style.display = 'flex';
          else emptyView.style.display = 'flex';
      }

      // --- 1. 장소 목록 이벤트 바인딩 ---
      function bindPlaceItemEvents() {
          const placeItems = document.querySelectorAll('.place-item');
          placeItems.forEach(item => {
              item.addEventListener('click', function() {
                  placeItems.forEach(i => i.classList.remove('selected'));
                  this.classList.add('selected');

                  const placeData = this.getAttribute('data-place-json');
                  const place = JSON.parse(placeData);

                  showView('detail');
                  updateDetailView(place); // 상세 뷰 업데이트
              });
          });
      }

      // --- 2. 상세 보기(Detail View) 관련 로직 ---
      let detailMap = null;
      let detailMarker = null;

      function initDetailMap() {
          const mapContainer = document.getElementById('detail_map');
          if (!mapContainer || !kakao) return;

          const mapOption = {
              center: new kakao.maps.LatLng(37.5665, 126.9780),
              level: 3
          };
          detailMap = new kakao.maps.Map(mapContainer, mapOption);

          // 마커를 생성하고 지도에 표시합니다.
          detailMarker = new kakao.maps.Marker({
              position: mapOption.center,
              map: detailMap
          });
      }

      function updateDetailView(place) {
          if (!detailMap) {
              initDetailMap();
          }


          // 1. 상세 정보 패널의 각 요소를 변수에 담습니다.
          const detailTitle = document.getElementById('detailTitle');
          const detailUserIcon = document.getElementById('detailUserIcon');
          const detailUserName = document.getElementById('detailUserName');
          const detailDate = document.getElementById('detailDate');
          const detailTime = document.getElementById('detailTime');
          const detailAddress = document.getElementById('detailAddress');
          const detailContent = document.querySelector('#detailView .detail-content');

          // 2. DTO에서 받은 정보로 각 요소의 내용을 채웁니다.
          detailTitle.textContent = place.title;
          detailUserName.textContent = place.createdBy;
          detailUserIcon.style.backgroundImage = `url('${place.userImg || '/images/default-profile.png'}')`;
          detailContent.textContent = place.description || '상세 내용이 없습니다.';
          detailAddress.textContent = place.address;

          // [수정 1] 아이콘에 글자를 넣는 대신, 배경 이미지(backgroundImage) 스타일을 직접 설정합니다.
          detailUserIcon.style.backgroundImage = `url('${place.userImg || '/images/default-profile.png'}')`;

          // [수정 2] description 데이터를 상세 내용(detailContent)에 채워줍니다.
          detailContent.textContent = place.description || '상세 내용이 없습니다.';

          // 날짜와 시간 포맷팅
          const formatDate = (datetime) => {
        if (!datetime) return '미정';
        const date = new Date(datetime);
        return `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        };
          detailStartDate.textContent = formatDate(place.startDatetime);
          detailEndDate.textContent = formatDate(place.endDatetime);

          // 지도 위치 업데이트
          const position = new kakao.maps.LatLng(place.lat, place.lng);
          detailMap.setCenter(position); // 지도를 새로운 위치로 이동
          detailMarker.setPosition(position); // 마커를 새로운 위치로 이동
      }
      // --- 3. '일정 추가' 관련 로직 (기존 코드와 동일) ---
      // ... initAddMap, searchPlaces 등 '일정 추가' 관련 함수들 ...

      // 초기 뷰 설정
      showView('empty');
  });
  /*]]>*/
</script>

<script th:src="@{/js/Token.js}"></script>

</body>
</html>